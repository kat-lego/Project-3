<!DOCTYPE html>
<html>
<head>
  <title>Leaderboard</title>
  <link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
<style>
table {
  border-collapse: collapse;
  border-spacing: 0;
  width: 100%;
  border: 1px solid #ddd;
}

#headerbackground {
  border: 10px;
  padding: 35px;
  background: #33e1f6;
  background-clip: content-box;
}

th, td {
  text-align: left;
  padding: 16px;
}

tr:nth-child(even) {
  background-color: #f2f2f2
}



body {
  font-family: 'Lato', sans-serif;
}

.overlay {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0, 0.9);
  overflow-x: hidden;
  transition: 0.5s;
}

.overlay-content {
  position: relative;
  top: 25%;
  width: 100%;
  text-align: center;
  margin-top: 30px;
}

.overlay a {
  padding: 8px;
  text-decoration: none;
  font-size: 36px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.overlay a:hover, .overlay a:focus {
  color: #f1f1f1;
}

.overlay .closebtn {
  position: absolute;
  top: 20px;
  right: 45px;
  font-size: 60px;
}

@media screen and (max-height: 450px) {
  .overlay a {font-size: 20px}
  .overlay .closebtn {
  font-size: 40px;
  top: 15px;
  right: 35px;
  }
}
</style>
</head>
<body>

<div id="headerbackground">
<h2 align = center>Competitive Assignments Leaderboard</h2>
</div>
<p>Leaderboard for all types of competitive assignments</p>

<div id="myNav" class="overlay">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <div class="overlay-content">
    <?php

    $username = "username";
    $password = "password";
    $database = "moodle";
          if($link = mysqli_connect("127.0.0.1", $username, $password, $database)){
                  $output=array();
                  if($result = mysqli_query($link, "SELECT * FROM mdl_customfeedback_assignment")){
                          while ($row=$result->fetch_assoc()){
                            $assignID = $row["id"];
                            $select.="<a href= 'http://1710409.ms.wits.ac.za/latest.php?LeaderboardName=$assignID'>$assignID</a>";
                          }
                  }
                  else{
                          die("failed to fetch data");
                  }

          }
          else{
                  die("failed to connect to the database");
          }
          mysqli_close($link);
          $output=strval(json_encode($output));
          $out=(array)json_decode($output,true);
          echo $select;
      //    die ($outout);
                          ?>
  </div>
</div>

<div class="tab">
  <button class="tablinks" onclick="openCity(event, 'Classic')" style="display:block"><i class="fas fa-dragon">&nbsp;</i>Classic mode</button>
  <button class="tablinks" onclick="openCity(event, 'Fastest')"><i class="fas fa-clock">&nbsp;</i>Fastest mode</button>
  <button class="tablinks" onclick="openCity(event, 'Optimal')"><i class="fa fa-briefcase">&nbsp;</i>Optimal Mode</button>
  <button class="tablinks" onclick="openCity(event, 'AI')"><i class="fas fa-brain"></i>&nbsp;AI mode</button>
  <button class="tablinks" onclick="openCity(event, 'Tournament')"><i class="fas fa-trophy"></i>&nbsp;Tournament mode</button>
</div>

<div id="Classic" class="tabcontent">
  <table>
<span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Select Assignment&emsp;&emsp;&emsp;&emsp;</span>
<input type="text" id="myInputClassic" onkeyup="myFunction('myInputClassic', 'Classic')" placeholder="Search for names.." title="Type in a name">
<br>
<tr>
  <th>Rank</th>
  <th>Name</th>
<?php
$username = "username";
$password = "password";
$database = "moodle";
$userAssignment = $_GET['LeaderboardName'];

    if($link = mysqli_connect("127.0.0.1", $username, $password, $database)){
            $output=array();
            if($result = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment'")){
                    while ($row=$result->fetch_assoc()){
                    $output[]=$row;
                    }
            }
            if($questionsResult = mysqli_query($link, "SELECT * FROM mdl_customfeedback_assignment WHERE id = '$userAssignment'")){
                    while ($questionsRow=$questionsResult->fetch_assoc()){
                    $questionsOutput[]=$questionsRow;
                    }
            }
            if($usersResult = mysqli_query($link, "SELECT DISTINCT user_id FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment'")){
                    while ($usersRow=$usersResult->fetch_assoc()){
                    $usersOutput[]=$usersRow;
                    }
            }
            else{
                    die("failed to fetch data");
            }

    }
    else{
            die("failed to connect to the database");
    }
    //mysqli_close($link);
    $str="<table>
        <th>username<th>
        <th>assignment<th>
    ";
  //echo "<th>test<th></tr>";
    //Places the users in the assignment, each with a rank
    $output=strval(json_encode($output));
    $out=(array)json_decode($output,true);

    $questionsOutput=strval(json_encode($questionsOutput)); //Places the number of questions in the assignment
    $questionsOut = (array)json_decode($questionsOutput, true);
    $numberOfQuestions = $questionsOut[0]["number_of_questions"];
    $thisQuestion = $questionsOut[0]["mode"];

    $usersOutput=strval(json_encode($usersOutput));
    $usersOut=(array)json_decode($usersOutput,true);

    $numberOfUsers = sizeof($usersOut);

    $outputForm = array();

    for($j=0; $j<$numberOfQuestions; $j++){
             $questionSort = $j + 1;
             $formatQuestions.="
             <th>Question $questionSort</th>";
    }
    $formatQuestions.= "<th>Total score</th>";

    for($u=0; $u<$numberOfUsers; $u++){
      $getUser=$usersOut[$u]["user_id"];

      for($questionNumber=0; $questionNumber<$numberOfQuestions; $questionNumber++){
          if($resultForm = mysqli_query($link, "SELECT COUNT(*) FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment' AND user_id='$getUser' AND question_number='$questionNumber'")){
                while ($rowForm=$resultForm->fetch_assoc()){
                  if($rowForm["COUNT(*)"] == 1){
                    if($resultForm = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment' AND user_id='$getUser' AND question_number='$questionNumber'")){
                          while ($rowForm=$resultForm->fetch_assoc()){
                            $outputForm[]=$rowForm;
                          }
                        }
                  }
                  else{
                    $str = array(question_number => $questionNumber, assign_id => $userAssignment, user_id => $getUser,
                    memory => -1, runtime => -1, no_of_submittions => -1, );
                    $outputForm[] = $str;
                    //echo $str;
                  }
                }
        }
      }
  }
  //echo json_encode($outputForm[2]);
  $userRank = 1;

    for($j=0;$j<sizeof($outputForm);$j=$j+$numberOfQuestions){
               $username=$outputForm[$j]['user_id'];
               $storeTotal = 0;
               $format.="
               <tr>
                       <td>$userRank</td>
                       <td>$username</td>";

               for($i = $j; $i <$numberOfQuestions+$j; ++$i){
                  $score=$outputForm[$i]["score"];
                   if(strlen($score) > 0){
                     $format.= "<td>$score</td>";
                     $storeTotal+= $score;
                   }
                   else{
                      $score="No Submission Found";
                      $format.= "<td>$score</td>";
                   }
                 }
               $format.= "
               <td>$storeTotal</td>
               </tr>";
     ++$userRank;
     }
   //echo json_encode($outputForm);


    //  break;

    mysqli_close($link);
    echo "<p>Showing Leaderboard for: ".$userAssignment."</p>";
    echo "<p>The number of questions in this assignment is: ".$numberOfQuestions."</p>";

    if($thisQuestion != "Classic Mode"){
      $formatQuestions = ' ';
      $format = ' ';
      echo '(*) This assignment does not have a classic mode';
    }


  echo $formatQuestions.$format."</table>";
    ?>
</div>


<div id="Fastest" class="tabcontent">
  <table>
<span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Select Assignment&emsp;&emsp;&emsp;&emsp;</span>
<input type="text" id="myInputFastest" onkeyup="myFunction('myInputFastest', 'Fastest')" placeholder="Search for names.." title="Type in a name">   <tr>
    <th>Rank</th>
    <th>Name</th>

  <?php
$username = "username";
$password = "password";
$database = "moodle";
        if($link = mysqli_connect("127.0.0.1", $username, $password, $database)){
                $outputF=array();
                if($resultF = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment'")){
                        while ($rowF=$resultF->fetch_assoc()){
                $outputF[]=$rowF;
                }
                }
                else{
                        die("failed to fetch data");
                }

        }
        else{
                die("failed to connect to the database");
        }
        mysqli_close($link);
        echo "<p>Showing Leaderboard for: ".$userAssignment."</p>";
        echo "<p>The number of questions in this assignment is: ".$numberOfQuestions."</p>";

        for($j=0; $j<$numberOfQuestions; $j++){
                 $questionSort = $j + 1;
                 $formatQuestions.="
                 <th>Question $questionSort /ms</th>";
        }
        $formatQuestions.= "<th>Total time /ms</th>";

        for($u=0; $u<$numberOfUsers; $u++){
          $getUser=$usersOut[$u]["user_id"];

          for($questionNumber=0; $questionNumber<$numberOfQuestions; $questionNumber++){
              if($resultForm = mysqli_query($link, "SELECT COUNT(*) FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment' AND user_id='$getUser' AND question_number='$questionNumber'")){
                    while ($rowForm=$resultForm->fetch_assoc()){
                      if($rowForm["COUNT(*)"] == 1){
                        if($resultForm = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment' AND user_id='$getUser' AND question_number='$questionNumber'")){
                              while ($rowForm=$resultForm->fetch_assoc()){
                                $outputForm[]=$rowForm;
                              }
                            }
                      }
                      else{
                        $str = array(question_number => $questionNumber, assign_id => $userAssignment, user_id => $getUser,
                        memory => -1, runtime => -1, no_of_submittions => -1, );
                        $outputForm[] = $str;
                        //echo $str;
                      }
                    }
            }
          }
      }
      //echo json_encode($outputForm[2]);
      $userRank = 1;

        for($j=0;$j<sizeof($outputForm);$j=$j+$numberOfQuestions){
                   $username=$outputForm[$j]['user_id'];
                   $storeTotal = 0;
                   $formatF.="
                   <tr>
                           <td>$userRank</td>
                           <td>$username</td>";

                   for($i = $j; $i <$numberOfQuestions+$j; ++$i){
                      $score=$outputForm[$i]["score"];
                       if(strlen($score) > 0){
                         $formatF.= "<td>$score</td>";
                         $storeTotal+= $score;
                       }
                       else{
                          $score="No Submission Found";
                          $formatF.= "<td>$score</td>";
                       }
                     }
                   $formatF.= "
                   <td>$storeTotal</td>
                   </tr>";
         ++$userRank;
         }

          if($thisQuestion != "Fastest Mode"){
            $formatQuestions = ' ';
            $formatF = ' ';
            echo '(*) This assignment does not have a fastest mode';
          }

          echo $formatQuestions.$formatF."</table>";
  ?>
</div>

<div id="Optimal" class="tabcontent">
  <table>
<span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Select Assignment&emsp;&emsp;&emsp;&emsp;</span>
<input type="text" id="myInputOptimal" onkeyup="myFunction('myInputOptimal', 'Optimal')" placeholder="Search for names.." title="Type in a name">   <tr>
    <th>Name</th>
    <th>Score</th>
    <th>Division</th>
  <?php
$username = "username";
$password = "password";
$database = "moodle";
        if($link = mysqli_connect("127.0.0.1", $username, $password, $database)){
                $output=array();
                if($result = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment'")){
                        while ($row=$result->fetch_assoc()){
                $output[]=$row;
                }
                }
                else{
                        die("failed to fetch data");
                }

        }
        else{
                die("failed to connect to the database");
        }
        mysqli_close($link);
        echo "<p>Showing Leaderboard for: ".$userAssignment."</p>";
        echo "<p>The number of questions in this assignment is: ".$numberOfQuestions."</p>";
        $output=strval(json_encode($output));
        $out=(array)json_decode($output,true);
        for($i=0;$i<sizeof($out);$i++){
                $username=$out[$i]["user_id"];
                $score=$out[$i]["status"];
                $format.="<tr>
                        <td>
                        $username
                                                </td>
                                                <td>
                                                 $score
                                                </td>
                                        </tr>
                                        ";
                                }

                                //echo $format."</table>";
          if($thisQuestion != "OptiMode"){
            $formatQuestions = ' ';
            $formatF = ' ';
            echo '(*) This assignment does not have an optimal mode';
          }
                        ?>
</table>
</div>

<div id="Tournament" class="tabcontent">
  <table>
<span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Select Assignment&emsp;&emsp;&emsp;&emsp;</span>
<input type="text" id="myInputTournament" onkeyup="myFunction('myInputTournament', 'Tournament')" placeholder="Search for names.." title="Type in a name">   <tr>
    <th>Name</th>
    <th>Score</th>
    <th>Division</th>
  <?php
$username = "username";
$password = "password";
$database = "moodle";
        if($link = mysqli_connect("127.0.0.1", $username, $password, $database)){
                $output=array();
                if($result = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment'")){
                        while ($row=$result->fetch_assoc()){
                $output[]=$row;
                }
                }
                else{
                        die("failed to fetch data");
                }

        }
        else{
                die("failed to connect to the database");
        }
        mysqli_close($link);
        echo "<p>Showing Leaderboard for: ".$userAssignment."</p>";
        echo "<p>The number of questions in this assignment is: ".$numberOfQuestions."</p>";
        $output=strval(json_encode($output));
        $out=(array)json_decode($output,true);
        for($i=0;$i<sizeof($out);$i++){
                $username=$out[$i]["user_id"];
                $score=$out[$i]["status"];
                $format.="<tr>
                        <td>
                        $username
                                                </td>
                                                <td>
                                                 $score
                                                </td>
                                        </tr>
                                        ";
                                }

                                //echo $format."</table>";

          if($thisQuestion != "Tournament Mode"){
            $formatQuestions = ' ';
            $formatF = ' ';
            echo '(*) This assignment does not have a tournament mode';
          }
                        ?>
</table>
</div>

<div id="AI" class="tabcontent">
  <table>
<span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Select Assignment&emsp;&emsp;&emsp;&emsp;</span>
<input type="text" id="myInputAI" onkeyup="myFunction('myInputAI', 'AI')" placeholder="Search for names.." title="Type in a name">   <tr>
    <th>Name</th>
    <th>Score</th>
    <th>Division</th>
  </tr>
  <?php
$username = "username";
$password = "password";
$database = "moodle";
        if($link = mysqli_connect("127.0.0.1", $username, $password, $database)){
                $output=array();
                if($result = mysqli_query($link, "SELECT * FROM mdl_customfeedback_submission WHERE assign_id = '$userAssignment'")){
                        while ($row=$result->fetch_assoc()){
                $output[]=$row;
                }
                }
                else{
                        die("failed to fetch data");
                }

        }
        else{
                die("failed to connect to the database");
        }
        mysqli_close($link);
        echo "<p>Showing Leaderboard for: ".$userAssignment."</p>";
        echo "<p>The number of questions in this assignment is: ".$numberOfQuestions."</p>";
        $output=strval(json_encode($output));
        $out=(array)json_decode($output,true);
        for($i=0;$i<sizeof($out);$i++){
                $username=$out[$i]["user_id"];
                $score=$out[$i]["status"];
                $format.="<tr>
                        <td>
                        $username
                                                </td>
                                                <td>
                                                 $score
                                                </td>
                                        </tr>
                                        ";
                                }

                              //  echo $format."</table>";
        if($thisQuestion != "AI Mode"){
          $formatQuestions = ' ';
          $formatF = ' ';
          echo '(*) This assignment does not have an AI mode';
        }
                        ?>
</table>
</div>

<script>
function openNav() {
  document.getElementById("myNav").style.width = "100%";
}

function closeNav() {
  document.getElementById("myNav").style.width = "0%";
}

document.getElementsByClassName('tablinks')[0].click();
function openCity(evt, cityName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}

function myFunction(inputName, tableName) {
  var input, filter, table, tr, td, i, txtValue;
  input = document.getElementById(inputName);
  filter = input.value.toUpperCase();
  table = document.getElementById(tableName);
  tr = table.getElementsByTagName("tr");
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[1];
    if (td) {
      txtValue = td.textContent || td.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }
  }
}
</script>
</html>
